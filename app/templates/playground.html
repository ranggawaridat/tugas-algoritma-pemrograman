{% extends "base.html" %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-white mb-2">Algorithm Playground</h1>
    <p class="text-gray-400">Test search and sort algorithms with complexity analysis.</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Configuration Panel -->
    <div class="lg:col-span-1 space-y-6">
        <div class="glass-panel p-6 rounded-2xl">
            <form action="/playground/run" method="post" id="algoForm">
                <input type="hidden" name="algo_type" id="algoTypeInput"
                    value="{{ selected_algo_type if selected_algo_type else 'sorting' }}">

                <h3 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">Configuration</h3>

                <div class="mb-4">
                    <label class="block text-gray-400 mb-2 text-sm">Mode</label>
                    <div class="flex p-1 bg-slate-900 rounded-lg">
                        <button type="button" onclick="setMode('sorting')" id="btn-sorting"
                            class="flex-1 py-2 text-sm rounded-md transition {% if not selected_algo_type or selected_algo_type == 'sorting' %}bg-primary text-white shadow{% else %}text-gray-400 hover:text-white{% endif %}">Sorting</button>
                        <button type="button" onclick="setMode('searching')" id="btn-searching"
                            class="flex-1 py-2 text-sm rounded-md transition {% if selected_algo_type == 'searching' %}bg-primary text-white shadow{% else %}text-gray-400 hover:text-white{% endif %}">Searching</button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-400 mb-2 text-sm">Algorithm</label>
                    <select name="algorithm" id="sorting-select"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white {% if selected_algo_type == 'searching' %}hidden{% endif %}">
                        <option value="bubble" {% if selected_algorithm=='bubble' %}selected{% endif %}>Bubble Sort
                        </option>
                        <option value="selection" {% if selected_algorithm=='selection' %}selected{% endif %}>Selection
                            Sort</option>
                        <option value="insertion" {% if selected_algorithm=='insertion' %}selected{% endif %}>Insertion
                            Sort</option>
                        <option value="merge" {% if selected_algorithm=='merge' %}selected{% endif %}>Merge Sort
                        </option>
                        <option value="shell" {% if selected_algorithm=='shell' %}selected{% endif %}>Shell Sort
                        </option>
                    </select>
                    <select name="algorithm" id="searching-select"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white {% if not selected_algo_type or selected_algo_type == 'sorting' %}hidden{% endif %}">
                        <option value="linear" {% if selected_algorithm=='linear' %}selected{% endif %}>Linear Search
                        </option>
                        <option value="sequential" {% if selected_algorithm=='sequential' %}selected{% endif %}>
                            Sequential Search</option>
                        <option value="binary" {% if selected_algorithm=='binary' %}selected{% endif %}>Binary Search
                            (Sorted)</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-400 mb-2 text-sm">Sort/Search By Key</label>
                    <select name="sort_key"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white">
                        <option value="nama" {% if selected_key=='nama' %}selected{% endif %}>Nama</option>
                        <option value="nim" {% if selected_key=='nim' %}selected{% endif %}>NIM</option>
                        <option value="ipk" {% if selected_key=='ipk' %}selected{% endif %}>IPK</option>
                    </select>
                </div>

                <div class="mb-4 {% if selected_algo_type == 'searching' %}hidden{% endif %}" id="sort-order-group">
                    <label class="block text-gray-400 mb-2 text-sm">Order</label>
                    <div class="flex gap-4">
                        <label class="flex items-center text-gray-400 cursor-pointer">
                            <input type="radio" name="sort_order" value="asc"
                                class="mr-2 text-indigo-500 focus:ring-indigo-500" {% if not selected_order or
                                selected_order=='asc' %}checked{% endif %}>
                            Ascending
                        </label>
                        <label class="flex items-center text-gray-400 cursor-pointer">
                            <input type="radio" name="sort_order" value="desc"
                                class="mr-2 text-indigo-500 focus:ring-indigo-500" {% if selected_order=='desc'
                                %}checked{% endif %}>
                            Descending
                        </label>
                    </div>
                </div>

                <div id="target-input-group"
                    class="mb-6 {% if not selected_algo_type or selected_algo_type == 'sorting' %}hidden{% endif %}">
                    <label class="block text-gray-400 mb-2 text-sm">Target Value</label>
                    <input type="text" name="target_input" value="{{ target_input if target_input else '' }}"
                        class="w-full bg-slate-900/50 border border-white/10 rounded-lg px-4 py-2 focus:outline-none focus:border-indigo-500 text-white placeholder-gray-500"
                        placeholder="e.g. John Doe or 3.5">
                </div>

                <button type="submit"
                    class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-indigo-500/20">
                    Run Algorithm
                </button>
            </form>

            <div class="mt-8">
                <h4 class="text-sm font-bold text-gray-400 mb-2 uppercase">Current Data ({{ students|length }})</h4>
                <div
                    class="bg-slate-900/50 rounded-lg border border-white/5 p-2 max-h-60 overflow-y-auto text-xs font-mono">
                    {% for student in students %}
                    <div class="mb-1 text-gray-400 border-b border-white/5 pb-1">
                        <span class="text-indigo-400">{{ student.nim }}</span> - {{ student.nama }} [{{ student.ipk }}]
                    </div>
                    {% else %}
                    <div class="text-gray-500 text-center py-4">No student data found. Add students first.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="lg:col-span-2">
        {% if error %}
        <div class="bg-red-500/20 text-red-200 p-4 rounded-xl mb-6 border border-red-500/30">
            {{ error }}
        </div>
        {% endif %}

        {% if result %}
        <div class="glass-panel p-6 rounded-2xl mb-6">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                <span class="w-2 h-8 bg-green-500 rounded-full mr-3"></span>
                Execution Results
            </h3>

            <div class="grid grid-cols-2 display-gap gap-4 mb-6">
                <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                    <span class="text-gray-400 text-xs uppercase block mb-1">Time Complexity</span>
                    <span class="text-xl font-mono text-purple-400">{{ result.complexity }}</span>
                </div>
                <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                    <span class="text-gray-400 text-xs uppercase block mb-1">Time Taken</span>
                    <span class="text-xl font-mono text-blue-400">{{ result.time_taken }}</span>
                </div>
                <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                    <span class="text-gray-400 text-xs uppercase block mb-1">Steps/Ops</span>
                    <span class="text-xl font-mono text-pink-400">{{ result.steps }}</span>
                </div>
                {% if selected_algo_type == 'searching' %}
                <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                    <span class="text-gray-400 text-xs uppercase block mb-1">Found</span>
                    <span
                        class="text-xl font-mono {% if result.found %}text-green-400{% else %}text-red-400{% endif %}">
                        {{ "YES" if result.found else "NO" }} {% if result.found %}(Index: {{ result.index }}){% endif
                        %}
                    </span>
                </div>
                {% endif %}
            </div>

            {% if selected_algo_type == 'sorting' %}
            <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                <span class="text-gray-400 text-xs uppercase block mb-2">Sorted Output</span>
                <div class="font-mono text-xs text-gray-300 break-all leading-relaxed max-h-96 overflow-y-auto">
                    {% for item in result.data %}
                    <div class="mb-1 border-b border-white/5 pb-1">
                        <span class="text-indigo-400">{{ item.nim }}</span> - {{ item.nama }} [IPK: {{ item.ipk }}]
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if selected_algo_type == 'searching' and result.found %}
            <div class="bg-green-500/10 p-4 rounded-xl border border-green-500/20 mt-4">
                <span class="text-green-400 text-xs uppercase block mb-2">Found Item</span>
                {% set found_item = students[result.index] if selected_algorithm != 'binary' else
                result.data[result.index] if result.data else students[result.index] %}
                <!-- Note: binary search uses sorted list which might differ from original 'students' list order. 
                     However, result.index from binary search refers to the sorted list index.
                     Ideally we should return the object found in SearchResult.
                     But for now, let's just highlight that we found it.
                -->
                <div class="font-mono text-sm text-white">
                    Target "{{ target_input }}" found at index {{ result.index }}.
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div
            class="glass-panel p-12 rounded-2xl flex flex-col items-center justify-center text-center opacity-50 border-dashed border-2 border-gray-600">
            <svg class="w-16 h-16 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                </path>
            </svg>
            <h3 class="text-xl font-bold text-gray-400">Ready to Analyze</h3>
            <p class="text-gray-500 mt-2">Configure parameters and run to see algorithm performance on your Student
                Data.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function setMode(mode) {
        document.getElementById('algoTypeInput').value = mode;
        const sortBtn = document.getElementById('btn-sorting');
        const searchBtn = document.getElementById('btn-searching');
        const sortSelect = document.getElementById('sorting-select');
        const searchSelect = document.getElementById('searching-select');
        const targetGroup = document.getElementById('target-input-group');
        const sortOrderGroup = document.getElementById('sort-order-group');

        // Reset classes
        sortBtn.className = "flex-1 py-2 text-sm rounded-md transition text-gray-400 hover:text-white";
        searchBtn.className = "flex-1 py-2 text-sm rounded-md transition text-gray-400 hover:text-white";

        if (mode === 'sorting') {
            sortBtn.className = "flex-1 py-2 text-sm rounded-md transition bg-primary text-white shadow";
            sortSelect.classList.remove('hidden');
            searchSelect.classList.add('hidden');
            sortSelect.removeAttribute('disabled');
            searchSelect.setAttribute('disabled', 'true'); // Disable to prevent submitting wrong field
            targetGroup.classList.add('hidden');
            if (sortOrderGroup) sortOrderGroup.classList.remove('hidden');
        } else {
            searchBtn.className = "flex-1 py-2 text-sm rounded-md transition bg-primary text-white shadow";
            sortSelect.classList.add('hidden');
            searchSelect.classList.remove('hidden');
            searchSelect.removeAttribute('disabled');
            sortSelect.setAttribute('disabled', 'true');
            targetGroup.classList.remove('hidden');
            if (sortOrderGroup) sortOrderGroup.classList.add('hidden');
        }
    }
</script>
{% endblock %}